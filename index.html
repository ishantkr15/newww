<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jethalal's Jalebi Rush</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Poppins:wght@400;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #87CEEB;
            font-family: 'Poppins', sans-serif;
            touch-action: none; /* Prevent pull-to-refresh on mobile */
            user-select: none;
            -webkit-user-select: none;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }

        .hud {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            font-family: 'Fredoka One', cursive;
            color: white;
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            font-size: clamp(18px, 5vw, 28px);
            z-index: 20;
        }

        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            pointer-events: auto;
            width: 90%;
            max-width: 400px;
            border: 4px solid #FF9933;
            z-index: 50;
        }

        .btn-start {
            background: #FF9933; /* Saffronish */
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Fredoka One', cursive;
            transition: transform 0.1s;
            margin-top: 20px;
            box-shadow: 0 4px 0 #cc7a29;
            width: 100%;
        }

        .btn-start:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .character-preview {
            font-size: 4rem;
            margin: 10px;
            animation: bounce 1s infinite;
            display: inline-block;
        }
        
        /* Mobile Controls */
        .mobile-controls {
            display: none; /* Hidden on PC by default, shown via JS if touch */
            position: absolute;
            bottom: 20px;
            width: 100%;
            padding: 0 20px;
            justify-content: space-between;
            pointer-events: auto;
            box-sizing: border-box;
        }
        
        .control-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
            backdrop-filter: blur(4px);
            touch-action: manipulation;
        }
        
        .control-btn:active {
            background: rgba(255, 255, 255, 0.6);
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
            }
            .controls-hint {
                display: none;
            }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* CRT Effect Overlay */
        .scanlines {
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.1) 50%,
                rgba(0,0,0,0.1)
            );
            background-size: 100% 4px;
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            pointer-events: none;
            z-index: 5;
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <canvas id="gameCanvas"></canvas>

    <div class="ui-layer">
        <div class="hud">
            <div id="scoreDisplay">ü•® 0</div>
            <div id="stressDisplay">üòì 0%</div>
        </div>
        
        <!-- Mobile Controls -->
        <div class="mobile-controls">
            <div class="control-btn" id="btnLeft">‚¨ÖÔ∏è</div>
            <div class="control-btn" id="btnRight">‚û°Ô∏è</div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" class="modal">
        <div class="character-preview">üë®üèª</div>
        <h1 class="text-3xl font-bold text-orange-600 mb-2" style="font-family: 'Fredoka One'">Gada Electronics Run</h1>
        <p class="text-gray-700 mb-4 text-sm">Dukaan late ho gaya! Help <b>Jethalal</b> dodge the Gokuldham wasis!</p>
        <div class="text-xs text-left bg-orange-100 p-3 rounded-lg mb-4 border border-orange-200">
            <p class="font-bold mb-1">Target: Collect ü•® Jalebis</p>
            <p class="mb-1">üõë <b>Beware of:</b></p>
            <div class="grid grid-cols-2 gap-1">
                <span>üë¥ Bapuji (Scolds)</span>
                <span>üíÉ Daya (Garba)</span>
                <span>üß™ Iyer (Science)</span>
                <span>üöï Sunder (Loot)</span>
            </div>
        </div>
        <button class="btn-start" onclick="startGame()">Tap to Play</button>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="modal" style="display: none;">
        <div class="character-preview" id="deathIcon">üòµ</div>
        <h1 class="text-3xl font-bold text-red-600 mb-2" style="font-family: 'Fredoka One'">Hey Maa Mataji!</h1>
        <p id="deathReason" class="text-gray-700 mb-2">Bapuji caught you.</p>
        <p class="text-xl font-bold mb-4 bg-yellow-100 p-2 rounded">Score: <span id="finalScore">0</span> Jalebis</p>
        <button class="btn-start" onclick="resetGame()">Try Again</button>
    </div>

<script>
    // --- Game Assets (Images) ---
    // REPLACE THESE URLS WITH REAL PNGs FOR BEST EXPERIENCE
    // Updated to use local files. Ensure you have an 'assets' folder with these images!
    const assets = {
        jethalal: { src: 'assets/jethalal.png', img: null },
        bapuji: { src: 'assets/bapuji.png', img: null },
        daya: { src: 'assets/daya.png', img: null },
        iyer: { src: 'assets/iyer.png', img: null },     // You need to find/make this one
        sunder: { src: 'assets/sunder.png', img: null }, // You need to find/make this one
        popat: { src: 'assets/popat.png', img: null },   // You need to find/make this one
        jalebi: { src: 'assets/jalebi.png', img: null }  // You need to find/make this one
    };

    function loadAssets() {
        for (let key in assets) {
            const img = new Image();
            img.src = assets[key].src;
            assets[key].img = img;
        }
    }
    loadAssets();

    // --- Game Constants & Setup ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let animationId;
    let score = 0;
    let stress = 0; 
    let gameSpeed = 5;
    let isGameOver = true;
    let frames = 0;
    let width, height;

    // Audio Context
    let audioCtx;
    const synth = window.speechSynthesis;
    let voices = [];

    function loadVoices() {
        voices = synth.getVoices();
    }
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = loadVoices;
    }

    function resizeCanvas() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // --- Audio Manager with More Dialogues ---
    const AudioMgr = {
        init: () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        },
        playTone: (freq, type, duration) => {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        },
        playCollect: () => {
            AudioMgr.playTone(800, 'sine', 0.1);
            setTimeout(() => AudioMgr.playTone(1200, 'sine', 0.1), 100);
        },
        playHit: () => {
            AudioMgr.playTone(150, 'sawtooth', 0.4);
        },
        speak: (text) => {
            if (synth.speaking) synth.cancel();
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.pitch = 1.1;
            utterThis.rate = 1.1;
            // Reverted to stricter Indian voice check
            const indianVoice = voices.find(v => v.lang.includes('IN') || v.name.includes('India'));
            if (indianVoice) utterThis.voice = indianVoice;
            
            synth.speak(utterThis);
        }
    };

    const Dialogues = {
        start: ["Jai Jinendra!", "Chalo chalo late ho raha hai!", "Aree Baap re!"],
        collect: ["Waah bhai waah!", "Maza aa gaya!", "Shanti!", "Best!"],
        hit: {
            bapuji: ["Babuchak!", "Kya karta hai tu!", "Nahane jaa!", "Besist Mhatara!"],
            daya: ["Hey Maa Mataji!", "Tapu ke papa!", "Garba time!", "Aree ruko!"],
            iyer: ["Jethalal!", "Nonsense!", "Scientist hoon main!", "Idiot!"],
            sunder: ["Behnoi ji!", "Taxi ka bhada do!", "Party!", "Kem cho!"],
            popat: ["Cancel!", "Duniya hila dunga!", "Shadi kara do!", "Main Journalist hoon!"]
        },
        gameover: ["Mehtus ko bulao!", "Gayi bhains paani mein!", "Hey bhagwaan!", "Nonsense!"]
    };

    function getRandomDialogue(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    // --- Game Entities ---

    class Player {
        constructor() {
            this.width = 60;
            this.height = 80;
            this.x = width / 2 - this.width / 2;
            this.y = height - this.height - 80; // Higher up for mobile thumb clearance
            this.speed = 7;
            this.velX = 0;
            this.image = assets.jethalal.img;
        }

        update() {
            if (keys.ArrowLeft) this.velX = -this.speed;
            else if (keys.ArrowRight) this.velX = this.speed;
            else this.velX = 0;

            this.x += this.velX;

            // Boundaries
            if (this.x < 0) this.x = 0;
            if (this.x + this.width > width) this.x = width - this.width;
        }

        draw() {
            if (this.image && this.image.complete) {
                ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
            } else {
                // Fallback
                ctx.font = '60px Arial';
                ctx.fillText('üë®üèª', this.x, this.y + 60);
            }
            
            // Stress Bar
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillRect(this.x, this.y - 15, this.width, 8);
            ctx.fillStyle = stress > 70 ? '#ff4444' : (stress > 40 ? 'orange' : '#44ff44');
            ctx.fillRect(this.x, this.y - 15, this.width * (stress/100), 8);
            ctx.strokeStyle = '#000';
            ctx.strokeRect(this.x, this.y - 15, this.width, 8);
        }
    }

    class Obstacle {
        constructor() {
            this.width = 55;
            this.height = 55;
            this.x = Math.random() * (width - this.width);
            this.y = -100;
            this.speed = gameSpeed + Math.random() * 2;
            
            const types = [
                { id: 'bapuji', asset: assets.bapuji, damage: 30, emoji: 'üë¥' },
                { id: 'daya', asset: assets.daya, damage: 20, emoji: 'üíÉ' },
                { id: 'iyer', asset: assets.iyer, damage: 15, emoji: 'üß™' },
                { id: 'sunder', asset: assets.sunder, damage: 25, emoji: 'üöï' },
                { id: 'popat', asset: assets.popat, damage: 10, emoji: '‚õ±Ô∏è' }
            ];
            
            this.type = types[Math.floor(Math.random() * types.length)];
            this.markedForDeletion = false;
        }

        update() {
            this.y += this.speed;
            if (this.y > height) this.markedForDeletion = true;
        }

        draw() {
            if (this.type.asset.img && this.type.asset.img.complete) {
                ctx.drawImage(this.type.asset.img, this.x, this.y, this.width, this.height);
            } else {
                ctx.font = '50px Arial';
                ctx.fillText(this.type.emoji, this.x, this.y + 50);
            }
        }
    }

    class Jalebi {
        constructor() {
            this.width = 45;
            this.height = 45;
            this.x = Math.random() * (width - this.width);
            this.y = -100;
            this.speed = gameSpeed;
            this.emoji = 'ü•®';
            this.markedForDeletion = false;
        }

        update() {
            this.y += this.speed;
            if (this.y > height) this.markedForDeletion = true;
        }

        draw() {
             // Just use emoji for Jalebi as it looks good, or placeholder if you want
             ctx.font = '40px Arial';
             ctx.fillText(this.emoji, this.x, this.y + 40);
        }
    }

    // --- Game Logic ---

    let player;
    let obstacles = [];
    let jalebis = [];
    let keys = { ArrowLeft: false, ArrowRight: false };

    function startGame() {
        AudioMgr.init();
        loadVoices();
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('gameOverScreen').style.display = 'none';
        
        resetGameVariables();
        isGameOver = false;
        gameSpeed = 5;
        
        AudioMgr.speak(getRandomDialogue(Dialogues.start));
        
        animate();
    }

    function resetGameVariables() {
        player = new Player();
        obstacles = [];
        jalebis = [];
        score = 0;
        stress = 0;
        frames = 0;
        updateHUD();
    }

    function updateHUD() {
        document.getElementById('scoreDisplay').innerText = `ü•® ${score}`;
        document.getElementById('stressDisplay').innerText = `üòì ${Math.floor(stress)}%`;
        document.getElementById('stressDisplay').style.color = stress > 80 ? '#ff4444' : 'white';
    }

    function resetGame() {
        startGame();
    }

    function handleCollision(rect1, rect2) {
        return (
            rect1.x < rect2.x + rect2.width &&
            rect1.x + rect1.width > rect2.x &&
            rect1.y < rect2.y + rect2.height &&
            rect1.height + rect1.y > rect2.y
        );
    }

    function gameOver(reason, typeId) {
        isGameOver = true;
        cancelAnimationFrame(animationId);
        
        document.getElementById('gameOverScreen').style.display = 'block';
        document.getElementById('finalScore').innerText = score;
        document.getElementById('deathReason').innerText = reason;
        
        // Set icon based on killer
        let icon = "üòµ";
        if(typeId === 'bapuji') icon = "üë¥";
        if(typeId === 'daya') icon = "üíÉ";
        document.getElementById('deathIcon').innerText = icon;
        
        AudioMgr.speak(getRandomDialogue(Dialogues.gameover));
    }

    function animate() {
        if (isGameOver) return;
        
        ctx.clearRect(0, 0, width, height);
        
        // Draw Responsive Background
        ctx.fillStyle = '#87CEEB';
        ctx.fillRect(0, 0, width, height);
        
        // Road/Ground
        ctx.fillStyle = '#E0C9A6';
        ctx.fillRect(0, height - 150, width, 150);
        
        // Sidewalk/Details
        ctx.fillStyle = '#C1A06E';
        ctx.fillRect(0, height - 150, width, 10);

        player.update();
        player.draw();

        frames++;
        if (frames % 500 === 0) gameSpeed += 0.5;

        // Dynamic Spawning based on screen width
        let spawnRate = width < 600 ? 100 : 90;
        
        if (frames % spawnRate === 0) obstacles.push(new Obstacle());
        if (frames % 60 === 0) jalebis.push(new Jalebi());

        // Handle Obstacles
        obstacles.forEach((obs, index) => {
            obs.update();
            obs.draw();
            
            if (handleCollision(player, obs)) {
                AudioMgr.playHit();
                // Play Character specific dialogue
                const lines = Dialogues.hit[obs.type.id];
                AudioMgr.speak(getRandomDialogue(lines));

                stress += obs.type.damage;
                obstacles.splice(index, 1);
                
                // Flash Screen
                ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                ctx.fillRect(0, 0, width, height);

                if (stress >= 100) {
                    gameOver(`${obs.type.id.charAt(0).toUpperCase() + obs.type.id.slice(1)} stressed you out!`, obs.type.id);
                }
            }
            if (obs.markedForDeletion) obstacles.splice(index, 1);
        });

        // Handle Jalebis
        jalebis.forEach((jalebi, index) => {
            jalebi.update();
            jalebi.draw();
            
            if (handleCollision(player, jalebi)) {
                AudioMgr.playCollect();
                score++;
                stress = Math.max(0, stress - 10); 
                
                if(score % 3 === 0) {
                    AudioMgr.speak(getRandomDialogue(Dialogues.collect));
                }

                jalebis.splice(index, 1);
            }
            if (jalebi.markedForDeletion) jalebis.splice(index, 1);
        });

        updateHUD();
        animationId = requestAnimationFrame(animate);
    }

    // --- Input Handling ---

    // Keyboard
    window.addEventListener('keydown', (e) => {
        if (keys.hasOwnProperty(e.code)) keys[e.code] = true;
    });

    window.addEventListener('keyup', (e) => {
        if (keys.hasOwnProperty(e.code)) keys[e.code] = false;
    });

    // Touch / Mobile Button Logic
    const btnLeft = document.getElementById('btnLeft');
    const btnRight = document.getElementById('btnRight');

    // Helper to stop propagation so we don't trigger other clicks
    const handleTouchStart = (dir, e) => {
        e.preventDefault(); // Stop mouse emulation
        if (dir === 'left') keys.ArrowLeft = true;
        if (dir === 'right') keys.ArrowRight = true;
    };

    const handleTouchEnd = (dir, e) => {
        e.preventDefault();
        if (dir === 'left') keys.ArrowLeft = false;
        if (dir === 'right') keys.ArrowRight = false;
    };

    // Attach events to on-screen buttons
    btnLeft.addEventListener('touchstart', (e) => handleTouchStart('left', e));
    btnLeft.addEventListener('touchend', (e) => handleTouchEnd('left', e));
    btnLeft.addEventListener('mousedown', (e) => handleTouchStart('left', e));
    btnLeft.addEventListener('mouseup', (e) => handleTouchEnd('left', e));

    btnRight.addEventListener('touchstart', (e) => handleTouchStart('right', e));
    btnRight.addEventListener('touchend', (e) => handleTouchEnd('right', e));
    btnRight.addEventListener('mousedown', (e) => handleTouchStart('right', e));
    btnRight.addEventListener('mouseup', (e) => handleTouchEnd('right', e));

    // Keep original tap-on-canvas logic as backup, but ignore if touching buttons
    canvas.addEventListener('touchstart', (e) => {
        if (e.target.classList.contains('control-btn')) return;
        
        // Only if clicking in middle/upper area
        const touchY = e.touches[0].clientY;
        if (touchY < height - 150) {
             const touchX = e.touches[0].clientX;
            if (touchX < width / 2) {
                keys.ArrowLeft = true;
                keys.ArrowRight = false;
            } else {
                keys.ArrowRight = true;
                keys.ArrowLeft = false;
            }
        }
    });

    canvas.addEventListener('touchend', (e) => {
        // Only clear if not holding buttons
        // This is simple approximation
        keys.ArrowLeft = false;
        keys.ArrowRight = false;
    });

</script>
</body>
</html>